<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- Copyright 2015-03-16T21:53:06-02:30, Rod Byrne --><title>threads</title>
<link rel="stylesheet" href="../css/online.css" type="text/css">
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
</head>
<body><div class="notes">
<div class="slide">
<h1>java threads</h1>
<div>
<p>
        A thread is an independent flow of execution
        in a program. A program starts with one thread,
        but can create many more. Each thread is
        independent of all other threads.
        Why threads? Threads
    </p>
<p><ul>
<li>
                allow user interaction while waiting for
                an external request to be satisfied.</li>
<li> 
                 allow multiple concurrent requests,
                 this reduces latency.
             </li>
<li>
                 allow servers to handle multiple requests.
             </li>
<li>
                 can support parallel processing on multi-processor
                 machines.
             </li>
<li>
                 can create games with concurrent activity.
             </li>
<li>
                 are required for multimedia.
             </li>
</ul></p>
</div>
</div>
<div class="slide">
<h1>Java Thread Class</h1>
<div>
<p>
        Some of the methods of the <code>java.lang.Thread</code> class.
    </p>
<dl>
<dt><tt>start()</tt></dt>
<dd>
            creates the thread and make it runnable.
        </dd>
<dt><tt>stop()</tt></dt>
<dd>
            stops the thread, should not be used.
        </dd>
<dt><tt>sleep(long millis)</tt></dt>
<dd>
            A static method that causes the <b>current</b> thread to
            <em>sleep</em> for <tt>millis</tt> milliseconds.
        </dd>
<dt><tt>yield()</tt></dt>
<dd>
            A static method that hints that the current thread should
            allow another thread to run.
        </dd>
<dt><tt>join()</tt></dt>
<dd>
            Suspends the current thread waiting for the specified
            thread to finish.
        </dd>
<dt><tt>int getId()</tt></dt>
<dd>
           Return the threads id.
        </dd>
<dt><tt>run()</tt></dt>
<dd>
           The method that is executed with the thread is started.
           This method must be overridden in any subclasses.
           If this thread was constructed with a <tt>Runnable</tt>,
           the <tt>run()</tt> of the <tt>Runnable</tt> is invoked.
        </dd>
</dl>
</div>
</div>
<div class="slide">
<h1>creating threads</h1>
<div>
<p>
        Threads are created by extending the
        <span class="code">java.lang.Thread</span>
        class or by passing a class that implements the
        <span class="code">java.lang.Runnable</span> to a
        <span class="code">java.lang.Thread</span> instance.
        Implementing the <span class="code">java.lang.Runnable</span>
        is preferred.
    </p>
<p>
        Creating threads by extending the java.lang.Thread is
        shown in the Babble class.
    </p>
<h2 class="src-name"><a href="tests/Babble.java">tests/Babble.java</a></h2>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Babble is an example of thread creation,</span>
<span class="cm"> * each Babble thread prints a messages, waits</span>
<span class="cm"> * a fixed time, and repeats forever.</span>
<span class="cm"> */</span>
<span class="kd">class</span> <span class="nc">Babble</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">delay</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Babble</span><span class="o">(</span> <span class="n">String</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">delay</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">delay</span> <span class="o">=</span> <span class="n">delay</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span> <span class="o">;;</span> <span class="o">)</span> <span class="o">{</span> <span class="c1">// common infinte loop idiom</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">msg</span> <span class="o">);</span>
                <span class="n">sleep</span><span class="o">(</span> <span class="n">delay</span> <span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span> <span class="c1">// end of this thread</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates two babblng threads, the initial</span>
<span class="cm">     * thread exits (terminates).</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Babble</span><span class="o">(</span> <span class="s">"hi"</span><span class="o">,</span> <span class="mi">250</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Babble</span><span class="o">(</span> <span class="s">"hello"</span><span class="o">,</span> <span class="mi">500</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// original thread is finished</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main done"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        A sample execution is:
    </p>
<div class="highlight"><pre>main done
hi
hello
hi
hi
hello
hi
hi
hello
hi
hello
.
.
.
</pre></div>
</div>
</div>
<div class="slide">
<h1>runnable interface</h1>
<div>
<p>
        The Thread class and Runnable interface specify the
    </p>
<div class="highlight"><pre>void run()
</pre></div>
<p>
        method. Execution of the new thread starts
        with the call to the <tt>run</tt> method. The thread terminates
        when the run method returns.
    </p>
<h2 class="src-name"><a href="tests/RunnableBabble.java">tests/RunnableBabble.java</a></h2>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Babble is an example of thread creation,</span>
<span class="cm"> * each Babble thread prints a messages waits</span>
<span class="cm"> * a fixed time, and repeats forever.</span>
<span class="cm"> */</span>
<span class="kd">class</span> <span class="nc">RunnableBabble</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">delay</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RunnableBabble</span><span class="o">(</span> <span class="n">String</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">int</span> <span class="n">delay</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">delay</span> <span class="o">=</span> <span class="n">delay</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span> <span class="o">;;</span> <span class="o">)</span> <span class="o">{</span> <span class="c1">// common infinte loop idiom</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">msg</span> <span class="o">);</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span> <span class="n">delay</span> <span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span> <span class="c1">// end of this thread</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Creates two babble threads, the initial</span>
<span class="cm">     * thread exists.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Babble</span><span class="o">(</span> <span class="s">"hi"</span><span class="o">,</span> <span class="mi">200</span> <span class="o">));</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Babble</span><span class="o">(</span> <span class="s">"hello"</span><span class="o">,</span> <span class="mi">600</span> <span class="o">));</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        Passing an object that implements the <code>Runnable</code>
        interface to a <code>Thread</code> is an example of 
        using <em>delegation</em> instead of <em>inheritance</em>.
    </p>
</div>
</div>
<div class="slide">
<h1>babble with lambdas</h1>
<div>
<p>
        Lambdas can also be used to define <code>Runnable</code>
        objects. A <code>Runnable</code> interface is a
        <em>functional</em> interface, there is only
        one <em>abstract</em> method.
    </p>
<h2 class="src-name"><a href="tests/LambdaBabble.java">tests/LambdaBabble.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">;</span>
<span class="cm">/**</span>
<span class="cm"> * Babble with lambdas</span>
<span class="cm"> */</span>
<span class="kd">class</span> <span class="nc">LambdaBabble</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">b1</span> <span class="o">=</span> <span class="s">"hi"</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">d1</span> <span class="o">=</span> <span class="mi">200</span><span class="o">;</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(;;){</span><span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b1</span><span class="o">);</span><span class="n">sleep</span><span class="o">(</span><span class="n">d1</span><span class="o">);}</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{}</span>
        <span class="o">}</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">String</span> <span class="n">b2</span> <span class="o">=</span> <span class="s">"hello"</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">d2</span> <span class="o">=</span> <span class="mi">300</span><span class="o">;</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(;;){</span><span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b2</span><span class="o">);</span><span class="n">sleep</span><span class="o">(</span><span class="n">d2</span><span class="o">);}</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{}</span>
        <span class="o">}</span> <span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        Notice that lambda expressions <em>captures</em>
        local variables, but these variables are constants,
        and they are not allowed to change.
    </p>
</div>
</div>
<div class="slide">
<h1>threading in java</h1>
<div>
<p>
        How does one CPU execute more than one thread?
    </p>
<p>
        Multitasking is supported by the Operating
        System and hardware with time sharing.
        In time sharing, a process/thread is allowed to
        executed for a fixed period before being
        preempted and suspended. The OS then picks
        the next thread/process to resume. The time
        sharing of N processes/threads is equivalent to having
        N CPUs with 1/Nth of the speed.
    </p>
<p>
        A thread can be:
    </p>
<ul>
<li>running, or</li>
<li>runnable, or</li>
<li>blocked.</li>
</ul>
<p>
        A runnable thread can continue execution when resumed.
        A blocked threaded is waiting for an external
        event (outside of the thread) and
        is not runnable until the external event occurs.
        Threads are normally blocked when performing
        I/O or when waiting for an external signal.
    </p>
<p>
        Threads share a common memory space.
        Processes are placed in their own memory space.
        Threads are called light-weight processes,
        since the overhead of switching between threads
        is much cheaper than switching processes.
    </p>
<p>
         Each thread has its own stack to store local variables
         and activation records.
    </p>
</div>
</div>
<div class="slide">
<h1>count down</h1>
<div>
<p>
        The CountDown program has two threads,
        one that will terminate the program
        after a fixed count if not stopped.
        The other thread accepts user input and if
        given "x" will prevent the count down
        from exiting the program.
    </p>
<h2 class="src-name"><a href="tests/CountDown.java">tests/CountDown.java</a></h2>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Count down to termination unless stopped.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDown</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">stop</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CountDown</span><span class="o">(</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"count = "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span> <span class="n">stop</span> <span class="o">)</span> <span class="k">return</span><span class="o">;</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span> <span class="mi">1000</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"too late"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">0</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * The initial thread starts with main.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"java CountDown limit"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="n">CountDown</span> <span class="n">cd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDown</span><span class="o">(</span> <span class="n">limit</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="n">cd</span> <span class="o">);</span>
        <span class="c1">// start the second thread.</span>
        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">ch</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span> <span class="o">(</span><span class="n">ch</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span><span class="n">ch</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'x'</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">cd</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"stop requested"</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'q'</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"quit main"</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"what?"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main done."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>Yielding</h1>
<div>
<p>
        The main goal for examining <em>yielding</em> is to see
        how thread scheduling results in <em>nondeterminism</em>.
        The scheduler is allowed to run any thread in any order,
        the scheduler can switch a thread at ant time.
    </p>
<p>
         Consider the following program that creates two
         threads, t1 and t2, that then use <span class="code">yield</span> to request
         that the other thread run.
    </p>
<h2 class="src-name"><a href="tests/Yield.java">tests/Yield.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Yield</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="c1">// static inner anonymou class declaration</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"B"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        In general, the output can not be easily determined.
        The <tt>taskset -c 0,1</tt> command limits execution
        to two CPUs (why?).
    </p>
<div class="highlight"><pre>% taskset -c 0,1 java Yield 
A0
B0
A1
B1
A2
B2
A3
B3
A4
B4
</pre></div>
<div class="highlight"><pre>% taskset -c 0,1 java Yield 
B0
A0
B1
A1
B2
A2
B3
A3
B4
A4
</pre></div>
<div class="highlight"><pre>% taskset -c 0,1 java Yield 
taskset -c 0,1 java Yield
B0
B1
B2
B3
B4
A0
A1
A2
A3
A4
</pre></div>
<p>
        The execution of the two threads is not always interleaved.
    </p>
</div>
</div>
<div class="slide">
<h1>yielding with lambdas</h1>
<div>
<p>
         Inner annonymous classes can be replaced by lambda expressions.
    </p>
<h2 class="src-name"><a href="tests/LambdaYield.java">tests/LambdaYield.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LambdaYield</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="c1">// lambda pass as argument, Thread expects a Runnable</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">);</span>
        <span class="c1">// lambda assigned to a Runnable</span>
        <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"B"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="n">r</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>yielding method table</h1>
<div>
<p>
        Sequence for <tt>taskset -c 0,1 java Yield</tt>.
    </p>
<table>
<tr>
<td> Sequence </td>
<td>t1 code</td>
<td>t2 code</td>
</tr>
<tr>
<td> 1 </td>
<td>print("A0")</td>
<td></td>
</tr>
<tr>
<td> 2 </td>
<td></td>
<td>print("B0")</td>
</tr>
<tr>
<td> 3 </td>
<td>print("A1")</td>
<td></td>
</tr>
<tr>
<td> 4 </td>
<td></td>
<td>print("B1")</td>
</tr>
<tr>
<td> 5 </td>
<td>print("A2")</td>
<td></td>
</tr>
<tr>
<td> 6 </td>
<td></td>
<td>print("B2")</td>
</tr>
<tr>
<td> 7 </td>
<td>print("A3")</td>
<td></td>
</tr>
<tr>
<td> 8 </td>
<td></td>
<td>print("B3")</td>
</tr>
<tr>
<td> 9 </td>
<td>print("A4")</td>
<td></td>
</tr>
<tr>
<td> 10 </td>
<td></td>
<td>print("B4")</td>
</tr>
</table>
<p>
        Sequence for <tt>taskset -c 0,1 java Yield</tt>.
    </p>
<table>
<tr>
<td> Sequence </td>
<td>t1 code</td>
<td>t2 code</td>
</tr>
<tr>
<td> 1 </td>
<td>print("A0")</td>
<td></td>
</tr>
<tr>
<td> 2 </td>
<td>print("A1")</td>
<td></td>
</tr>
<tr>
<td> 3 </td>
<td>print("A2")</td>
<td></td>
</tr>
<tr>
<td> 4 </td>
<td>print("A3")</td>
<td></td>
</tr>
<tr>
<td> 5 </td>
<td>print("A4")</td>
<td></td>
</tr>
<tr>
<td> 6 </td>
<td></td>
<td>print("B0")</td>
</tr>
<tr>
<td> 7 </td>
<td></td>
<td>print("B1")</td>
</tr>
<tr>
<td> 8 </td>
<td></td>
<td>print("B2")</td>
</tr>
<tr>
<td> 9 </td>
<td></td>
<td>print("B3")</td>
</tr>
<tr>
<td> 10 </td>
<td></td>
<td>print("B4")</td>
</tr>
</table>
</div>
</div>
<div class="slide">
<h1>Yielding char by char</h1>
<div>
<p>
        Both threads send characters to the standard output,
        notice that each thread now has two places
        when yielding (rescheduling) occurs.
    </p>
<h2 class="src-name"><a href="tests/YieldChar.java">tests/YieldChar.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YieldChar</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InterruptedException</span>
    <span class="o">{</span>
        <span class="c1">// static inner class declaration</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="sc">'A'</span><span class="o">);</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// sleep for 1 ms</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)(</span><span class="sc">'0'</span><span class="o">+</span><span class="n">i</span><span class="o">));</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="sc">'B'</span><span class="o">);</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// sleep for 1 ms</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)(</span><span class="sc">'a'</span><span class="o">+</span><span class="n">i</span><span class="o">));</span>
                        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>tests % taskset -c 1 java YieldChar
BAa0BAb1BAc2BAd3BAe4
tests % taskset -c 1 java YieldChar
BAa0BAb1BAc2BAd3BAe4
tests % taskset -c 1 java YieldChar
BAa0BAb1BAc2BAd3BAe4
tests % taskset -c 1 java YieldChar
BAa0BbABc1BdAB2eA3A4
</pre></div>
<p>
        The <tt>B</tt> followed by an <tt>A</tt>, shows
        that rescheduling happens at each <code>Thread.sleep</code> call.
    </p>
</div>
</div>
<div class="slide">
<h1>Yielding without I/O</h1>
<div>
<p>
         Consider the following program that creates two
         threads, t1 and t2, that then use yield to request
         that the other thread run. No I/O is performed by
         the threads. Adding elements to the ArrayList
         is still synchronized, which means that only
         one thread can be active inside of the
         <span class="code">synchronized</span> block.
         The other thread will be suspended, if it attempts
         to enter the <span class="code">synchronized</span> block.
    </p>
<h2 class="src-name"><a href="tests/Yield1.java">tests/Yield1.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Yield1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// al must be final since in appears in t1/t2</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">al</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">al</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">al</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="s">"A"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">al</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">al</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="s">"B"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="c1">// output list</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">al</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java Yield1
B0
B1
B2
B3
B4
A0
A1
A2
A3
A4
</pre></div>
<div class="highlight"><pre>% taskset -c 0 java Yield1 # only one process
B0
A0
B1
A1
B2
A2
B3
A3
B4
A4
</pre></div>
</div>
</div>
<div class="slide">
<h1>Yielding with timestamps</h1>
<div>
<p>
        The <tt>nanoTime()</tt> returns a time stamp in
        nanoseconds.
    </p>
<h2 class="src-name"><a href="tests/Yield2.java">tests/Yield2.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Yield2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// al1, al2, and start appear in the inner classes</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">al1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">al2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">al1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">al2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="c1">// output time stamps</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">al1</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"A%d=%d B%d=%d%n"</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">al1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">i</span><span class="o">,</span> <span class="n">al2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java Yield2
A0=1650309 B0=1580444
A1=1672263 B1=1672256
A2=1676274 B2=1676265
A3=1679833 B3=1679841
A4=1683251 B4=1683258
</pre></div>
<p>
        The sequence is: B0, A0, B1, A1, B2, A2, A3, B3, A4, B4.
    </p>
<div class="highlight"><pre>% java Yield2
A0=1483783 B0=1291601
A1=1533329 B1=1358239
A2=1541280 B2=1361726
A3=1548710 B3=1364745
A4=1556126 B4=1367824
</pre></div>
<p>
        The sequence is: B0, B1, B2, B3, B4, A0, A1, A2, A3, A4.
    </p>
<div class="highlight"><pre>% taskset -c 0 java Yield2
A0=1311914 B0=1183243
A1=1328938 B1=1324589
A2=1337116 B2=1333049
A3=1345052 B3=1341071
A4=1352772 B4=1348969
</pre></div>
</div>
</div>
<div class="slide">
<h1>yielding with TimeStamp</h1>
<div>
<p>
        Testing with <tt>TimeStamp</tt>.
    </p>
<h2 class="src-name"><a href="tests/Yield3.java">tests/Yield3.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="c1">// Used to record time stamps</span>
<span class="kd">class</span> <span class="nc">TimeStamp</span> <span class="kd">implements</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">seq</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">timeStamp</span><span class="o">;</span>
    <span class="n">TimeStamp</span><span class="o">(</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">seq</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeStamp</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeStamp</span> <span class="o">=</span> <span class="n">timeStamp</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// compare time using only timeStamp</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">TimeStamp</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">timeStamp</span> <span class="o">-</span> <span class="n">o</span><span class="o">.</span><span class="na">timeStamp</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span> <span class="o">+</span> <span class="n">seq</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">timeStamp</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Yield3</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;</span> <span class="n">al1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;</span> <span class="n">al2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;();</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">al1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">TimeStamp</span><span class="o">(</span> <span class="s">"A"</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">nanoTime</span><span class="o">()-</span><span class="n">start</span><span class="o">)</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">al2</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">TimeStamp</span><span class="o">(</span> <span class="s">"B"</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">nanoTime</span><span class="o">()-</span><span class="n">start</span><span class="o">)</span> <span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// use the main thread</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;</span> <span class="n">combined</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TimeStamp</span><span class="o">&gt;();</span>
        <span class="n">combined</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span> <span class="n">al1</span> <span class="o">);</span>
        <span class="n">combined</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span> <span class="n">al2</span> <span class="o">);</span>
        <span class="c1">// sort combined timeStamps by time</span>
        <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span> <span class="n">combined</span> <span class="o">);</span>
        <span class="c1">// output the time stamps in order</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">TimeStamp</span> <span class="n">ts</span> <span class="o">:</span> <span class="n">combined</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">ts</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java Yield3
B0 1760061
B1 1774637
B2 1777385
B3 1779826
B4 1782090
A0 1816926
A1 1850666
A2 1857369
A3 1863305
A4 1869143
</pre></div>
<div class="highlight"><pre>% taskset -c 0 java Yield3
B0 1733264
A0 1848962
B1 1860447
A1 1864954
B2 1868889
A2 1873155
B3 1876887
A3 1881077
B4 1885223
A4 1889157
</pre></div>
</div>
</div>
<div class="slide">
<h1>Parallel processing introduction</h1>
<div>
<p>
        If more than one CPU is available, then Java threads
        can be used to write a parallel processing program.
        A parallel processing program divides a problem
        into independent tasks that can executed in parallel
        and then combines the results to solve the problem.
        In theory, a problem can finish n times faster
        if there are n CPUs available.
    </p>
<p>
        The <tt>SumInterval</tt> class calculates the
        sum of the first <tt>k</tt> integers in parallel
        by calculating the sum in distinct non-overlapping ranges.
        The sum of the ranges is then calculated. Since
        these sums are independent, they can occur in parallel.
    </p>
<h2 class="src-name"><a href="tests/SumInterval.java">tests/SumInterval.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">SumThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">sum</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">startT</span><span class="o">,</span> <span class="n">endT</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SumThread</span><span class="o">(</span> <span class="kt">long</span> <span class="n">s</span><span class="o">,</span> <span class="kt">long</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">startT</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="o">;</span>
            <span class="n">x</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getElapsed</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">endT</span><span class="o">-</span><span class="n">startT</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStartT</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">startT</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getEndT</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">endT</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSum</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">sum</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SumInterval</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">range</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="kt">int</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">);</span>
        <span class="kt">long</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">range</span> <span class="o">/</span> <span class="n">threads</span><span class="o">;</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SumThread</span><span class="o">&gt;</span> <span class="n">sums</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SumThread</span><span class="o">&gt;();</span>
        <span class="kt">long</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">threads</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="c1">// using si as arguments is very bad style, why?</span>
            <span class="n">sums</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">SumThread</span><span class="o">(</span><span class="n">si</span><span class="o">,</span> <span class="n">si</span> <span class="o">+=</span> <span class="n">interval</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">sums</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">SumThread</span><span class="o">(</span><span class="n">si</span><span class="o">,</span> <span class="n">range</span><span class="o">));</span>

        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">SumThread</span> <span class="n">t</span> <span class="o">:</span> <span class="n">sums</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">range</span><span class="o">;</span> <span class="c1">// take care of the last sum</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">SumThread</span> <span class="n">t</span> <span class="o">:</span> <span class="n">sums</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="na">getSum</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"total = "</span> <span class="o">+</span> <span class="n">total</span> <span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"tt %11d %11d %11d%n"</span><span class="o">,</span>
            <span class="n">begin</span><span class="o">-</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">-</span><span class="n">begin</span> <span class="o">);</span>
	<span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------"</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sums</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">SumThread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">sums</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"t%d %11d %11d %11d%n"</span><span class="o">,</span>
                <span class="n">i</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getStartT</span><span class="o">()-</span><span class="n">begin</span><span class="o">,</span>
                <span class="n">t</span><span class="o">.</span><span class="na">getEndT</span><span class="o">()-</span><span class="n">begin</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getElapsed</span><span class="o">()</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        On a 4 CPU computer the results for calculating
        with 4 threads and 1 thread are:
    </p>
<div class="highlight"><pre>% taskset -c 0,1,2,3 java SumInterval 100000000 4
total = 5000000050000000
tt           0    45259748    45259748
--------------------------------------
t0      903818    43869460    42965642
t1     1092255    43843357    42751102
t2     1525858    45175362    43649504
t3     1527797    43998318    42470521
% taskset -c 0,1,2,3 java SumInterval 100000000 1
total = 5000000050000000
tt           0   137784050   137784050
--------------------------------------
t0      654508   137569212   136914704
</pre></div>
<p>
       The speed up is 3.044 (137784050/45259748).
       For 2 CPUs the result is:
    </p>
<div class="highlight"><pre>% taskset -c 0,1,2,3 java SumInterval 100000000 2
total = 5000000050000000
tt           0    77863180    77863180
--------------------------------------
t0      763062    77733229    76970167
t1      962714    77667480    76704766
</pre></div>
<p>
        The speed up with 2 CPU is 1.77 (137784050/77863180).
    </p>
</div>
</div>
<div class="slide">
<h1>speed up with different problem sizes</h1>
<div>
<p>
        The speed up is not as great for smaller problem sizes.
    </p>
<div class="highlight"><pre>% taskset -c 0,1,2,3 java SumInterval 1000 4
total = 500500
tt           0     2023655     2023655
--------------------------------------
t0      967124     1025014       57890
t1     1163898     1205529       41631
t2     1568838     1608497       39659
t3     1857892     1895008       37116
% taskset -c 0,1,2,3 java SumInterval 1000 1
total = 500500
tt           0     1009376     1009376
--------------------------------------
t0      647797      852862      205065
</pre></div>
<p>
        The speed up is 0.4987 (1009376.0/ 2023655.0).
        For small problem sizes, parallel programs can
        be slower!
    </p>
</div>
</div>
<div class="slide">
<h1>Racing</h1>
<div>
<p><em>Bad things can happen when too much is
        happening.</em> What does the following program
        output?
    </p>
<h2 class="src-name"><a href="tests/Race.java">tests/Race.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span>  <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Concurrency can cause confusion</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Race</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Accumulate</span> <span class="n">acc</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Race</span><span class="o">(</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">Accumulate</span> <span class="n">acc</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"java Race loops"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">loops</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">Accumulate</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Accumulate</span><span class="o">(</span> <span class="n">loops</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Race</span><span class="o">(</span> <span class="mi">19000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Race</span><span class="o">(</span> <span class="mi">18000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// wait for t1 to die</span>
            <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// wait for t2 to die</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">expected</span> <span class="o">=</span> <span class="mi">19000</span> <span class="o">+</span> <span class="mi">18000</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">acc</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="s">" == "</span> <span class="o">+</span> <span class="n">expected</span> <span class="o">);</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"elapsed = "</span> <span class="o">+</span> <span class="n">t</span> <span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Accumulate</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">loops</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">loopCount</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Accumulate</span><span class="o">(</span> <span class="kt">long</span> <span class="n">loops</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loops</span> <span class="o">=</span> <span class="n">loops</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sum</span><span class="o">;</span>
        <span class="c1">// provide a stopping point for the thread</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">loopCount</span><span class="o">++</span> <span class="o">;</span> <span class="c1">// do nothing really,</span>
           <span class="c1">// required to ensure execution</span>
        <span class="o">}</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        Thread t1 and t2 each call acc.inc(),
        these call occur concurrently.
        On a single processor their execution is interleaved.
        Interleaved means the one threads executes a number of
        statements, then the next thread executes a number of
        statements. The exact number is non-deterministic.
    </p>
<p>
        Thread t1 calls acc.inc(), sometimes this thread is suspended
        in the middle of the for loop in acc. The assignment,
        <blockquote><tt>int s = sum;</tt></blockquote>
        which occurs before the for loop, saves the value of sum in s.
        Thread t2 runs and calls t1.acc() several times before
        being suspended. When t1 resumes it updates sum with
        value saved in s, by
        <blockquote><tt>sum = s + 1;</tt></blockquote>
        thus any increments caused by t2 will be lost.
    </p>
<p>
        Try the following:
    </p>
<div class="highlight"><pre>% taskset -c 0 java Race 10
37000 == 37000
elapsed = 9
% taskset -c 0 java Race 100
37000 == 37000
elapsed = 12
% taskset -c 0 java Race 1000
32563 == 37000
elapsed = 39
</pre></div>
<p><tt>taskset</tt> ensures only one CPU is used to
        run the program.
    </p>
</div>
</div>
<div class="slide">
<h1>Trace of a race</h1>
<div>
<p>
        The program operates correctly in
        the following trace.
    </p>
<table>
<tr>
<td> Sequence </td>
<td> sum </td>
<td>t1 code</td>
<td>t1 s</td>
<td>t2 code</td>
<td>t2 s</td>
</tr>
<tr>
<td> 1 </td>
<td> 100 </td>
<td>int s = sum;</td>
<td> 100 </td>
<td></td>
<td></td>
</tr>
<tr>
<td> 2 </td>
<td> 100 </td>
<td>for(int i = 0; ...</td>
<td> 100 </td>
<td></td>
<td></td>
</tr>
<tr>
<td> 3 </td>
<td> 101 </td>
<td>sum = s + 1</td>
<td> 100 </td>
<td></td>
<td></td>
</tr>
<tr>
<td> 4 </td>
<td> 101 </td>
<td></td>
<td></td>
<td>int s = sum;</td>
<td> 101 </td>
</tr>
<tr>
<td> 5 </td>
<td> 101 </td>
<td></td>
<td></td>
<td>for(int i = 0; ...</td>
<td> 101 </td>
</tr>
<tr>
<td> 6 </td>
<td> 102 </td>
<td></td>
<td></td>
<td>sum = s + 1</td>
<td> 101 </td>
</tr>
</table>
<p>
        The program operates incorrectly in
        the following trace.
    </p>
<table>
<tr>
<td> Sequence </td>
<td> sum </td>
<td>t1 code</td>
<td>t1 s</td>
<td>t2 code</td>
<td>t2 s</td>
</tr>
<tr>
<td> 1 </td>
<td> 100 </td>
<td>int s = sum;</td>
<td> 100 </td>
<td>int s = sum</td>
<td>100</td>
</tr>
<tr>
<td> 2 </td>
<td> 100 </td>
<td>for(int i = 0; ...</td>
<td> 100 </td>
<td></td>
<td>100</td>
</tr>
<tr>
<td> 3 </td>
<td> 101 </td>
<td>sum = s + 1</td>
<td> 100 </td>
<td>for(int i = 0; ...</td>
<td>100</td>
</tr>
<tr>
<td> 4 </td>
<td> 101 </td>
<td></td>
<td></td>
<td></td>
<td>100</td>
</tr>
<tr>
<td> 5 </td>
<td> 101 </td>
<td></td>
<td>100</td>
<td>sum = s + 1</td>
<td> 100 </td>
</tr>
</table>
<p>
        The sum should be <tt>102</tt>.
    </p>
<p>
        The left side will run twice before the right side
        runs once.
    </p>
<table>
<tr>
<td> Sequence </td>
<td> sum </td>
<td>t1 code</td>
<td>t1 s</td>
<td>t2 code</td>
<td>t2 s</td>
</tr>
<tr>
<td> 1 </td>
<td> 101 </td>
<td>int s = sum;</td>
<td> 101 </td>
<td>int s = sum</td>
<td>101</td>
</tr>
<tr>
<td> 2 </td>
<td> 101 </td>
<td>for(int i = 0; ...</td>
<td> 101 </td>
<td></td>
<td>101</td>
</tr>
<tr>
<td> 3 </td>
<td> 102 </td>
<td>sum = s + 1</td>
<td> 101 </td>
<td></td>
<td>101</td>
</tr>
<tr>
<td> 4 </td>
<td> 102 </td>
<td>int s = sum;</td>
<td> 102 </td>
<td></td>
<td>101</td>
</tr>
<tr>
<td> 5 </td>
<td> 102 </td>
<td>for(int i = 0; ...</td>
<td> 102 </td>
<td></td>
<td>101</td>
</tr>
<tr>
<td> 6 </td>
<td> 103 </td>
<td>sum = s + 1</td>
<td> 102 </td>
<td></td>
<td>101</td>
</tr>
<tr>
<td> 7 </td>
<td> 103 </td>
<td></td>
<td></td>
<td>for(int i = 0; ...</td>
<td>101</td>
</tr>
<tr>
<td> 8 </td>
<td> 102 </td>
<td></td>
<td></td>
<td>sum = s + 1</td>
<td>101</td>
</tr>
</table>
</div>
</div>
<div class="slide">
<h1>Overlapping execution</h1>
<div>
<p>
        The CountRace class counts the number of overlaps.
    </p>
<h2 class="src-name"><a href="tests/CountRace.java">tests/CountRace.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span>  <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Count the overlaps</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountRace</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">CountAccumulate</span> <span class="n">acc</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CountRace</span><span class="o">(</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">CountAccumulate</span> <span class="n">acc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span> <span class="n">id</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"java CountRace loops"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="n">CountAccumulate</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountAccumulate</span><span class="o">(</span><span class="n">loops</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountRace</span><span class="o">(</span> <span class="mi">19000</span><span class="o">,</span> <span class="n">acc</span><span class="o">,</span> <span class="mi">0</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountRace</span><span class="o">(</span> <span class="mi">18000</span><span class="o">,</span> <span class="n">acc</span><span class="o">,</span> <span class="mi">1</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// wait for t1 to die</span>
            <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// wait for t2 to die</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">acc</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="s">" == "</span> <span class="o">+</span> <span class="mi">37000</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"overlaps = "</span> <span class="o">+</span> <span class="n">acc</span><span class="o">.</span><span class="na">getOverlap</span><span class="o">()</span> <span class="o">);</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"elapsed = "</span> <span class="o">+</span> <span class="n">t</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CountAccumulate</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">overlap</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loops</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">loopCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">busy</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CountAccumulate</span><span class="o">(</span> <span class="kt">int</span> <span class="n">loops</span><span class="o">,</span> <span class="kt">int</span> <span class="n">threads</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">overlap</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loops</span> <span class="o">=</span> <span class="n">loops</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">busy</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="n">threads</span><span class="o">];</span>

        <span class="k">for</span> <span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">busy</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">busy</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">startOverlap</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
        <span class="kt">boolean</span> <span class="n">over</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">boolean</span> <span class="n">b</span> <span class="o">:</span> <span class="n">busy</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">b</span> <span class="o">)</span> <span class="o">{</span> <span class="n">over</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="k">break</span><span class="o">;</span> <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">busy</span><span class="o">[</span><span class="n">id</span><span class="o">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">over</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">overlap</span><span class="o">++;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">endOverlap</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
        <span class="n">busy</span><span class="o">[</span><span class="n">id</span><span class="o">]</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">startOverlap</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sum</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> 
            <span class="n">loopCount</span><span class="o">++;</span> <span class="c1">// do nothing</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">endOverlap</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOverlap</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">overlap</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        Sample runs:
    </p>
<div class="highlight"><pre>tests % java CountRace 10
36694 == 37000
overlaps = 10696
elapsed = 32383583
tests % java CountRace 100
34476 == 37000
overlaps = 9771
elapsed = 46920563
tests % java CountRace 1000
36630 == 37000
overlaps = 10954
elapsed = 38875999
</pre></div>
</div>
</div>
<div class="slide">
<h1>Mutual exclusion</h1>
<div>
<p>
        To avoid the problems from the <span class="code">Race</span> program,
        the execution of the <span class="code">inc</span> methods must, when started,
        be completed before another thread can invoke <span class="code">inc</span>.
    </p>
<p>
        The body of the inc method is called a <b>critical 
        region</b>, since concurrent execution of the method
        can result in corruption of the program.
    </p>
<p>
        The <code>synchronized</code> keyword in Java,
        means that only one thread is allowed to execute
        <span class="code">inc</span> at a time. If another thread attempts to invoke
        <span class="code">inc</span>, it will be blocked until the thread executing
        <span class="code">inc</span> finishes.
        Synchronized methods are guaranteed to be mutually exclusive.
    </p>
<p>
        Each object in Java has an associated <b>lock</b>,
        only one thread can hold the <b>lock</b>. Once
        the lock is held, any other thread invoking
        the method will be blocked.
    </p>
<p>
        Since synchronizing methods is expensive, it should
        be avoided unless it is required.
        Any time suspension of a code segment can result
        in corruption, the code segment must
        be protected by synchronizing the method.
    </p>
<h2 class="src-name"><a href="tests/SafeRace.java">tests/SafeRace.java</a></h2>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">inc</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sum</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> 
        <span class="n">loopCount</span><span class="o">++;</span> <span class="c1">// do nothing</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>Safe race</h1>
<div>
<p>
        Only one thread can invoke the <span class="code">inc</span> method at a time.
        Any other thread invoking <span class="code">inc</span> will be blocked until
        the <span class="code">inc</span> method with the lock returns.
    </p>
<h2 class="src-name"><a href="tests/SafeRace.java">tests/SafeRace.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeRace</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SafeAccumulate</span> <span class="n">acc</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SafeRace</span><span class="o">(</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">SafeAccumulate</span> <span class="n">acc</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"java SafeRace loops"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">SafeAccumulate</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeAccumulate</span><span class="o">(</span> <span class="n">loops</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeRace</span><span class="o">(</span> <span class="mi">19000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeRace</span><span class="o">(</span> <span class="mi">18000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">acc</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="s">" == "</span> <span class="o">+</span> <span class="mi">37000</span> <span class="o">);</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"elapsed = "</span> <span class="o">+</span> <span class="n">t</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SafeAccumulate</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loops</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">loopCount</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SafeAccumulate</span><span class="o">(</span><span class="kt">int</span> <span class="n">loops</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">loops</span> <span class="o">=</span> <span class="n">loops</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// the only difference is the synchronized keyword</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">inc</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sum</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loops</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> 
            <span class="n">loopCount</span><span class="o">++;</span> <span class="c1">// do nothing</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>Synchronized code blocks</h1>
<div>
<p>
        Mutual exclusion is guaranteed for the entire body of a
        synchronized method. Mutual exclusion can affect
        the performance of a program by blocking other
        threads from access to the critical code for long periods.
        The blocking time can be reduced by synchronizing a
        smaller segment of code with:
        <blockquote><tt>synchronized( object ) { code }</tt></blockquote></p>
<p>
        A synchronized method is identical to placing
        a synchronized block around the method's body.
        Notice that synchronization is associated with
        an object.
    </p>
<h2 class="src-name"><a href="tests/SafeRaceBlock.java">tests/SafeRaceBlock.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SafeRaceBlock</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SafeAccumulateBlock</span> <span class="n">acc</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SafeRaceBlock</span><span class="o">(</span> <span class="kt">int</span> <span class="n">count</span><span class="o">,</span> <span class="n">SafeAccumulateBlock</span> <span class="n">acc</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">inc</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span>  <span class="o">{</span>
        <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">SafeAccumulateBlock</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeAccumulateBlock</span><span class="o">();</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeRaceBlock</span><span class="o">(</span> <span class="mi">9000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SafeRaceBlock</span><span class="o">(</span> <span class="mi">8000</span><span class="o">,</span> <span class="n">acc</span> <span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">acc</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">+</span> <span class="s">" == "</span> <span class="o">+</span> <span class="mi">17000</span> <span class="o">);</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">t</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"elapsed = "</span> <span class="o">+</span> <span class="n">t</span> <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SafeAccumulateBlock</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">loopCount</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SafeAccumulateBlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// the only difference is synchronized block</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span> <span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sum</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> 
                <span class="n">loopCount</span><span class="o">++;</span> <span class="c1">// do nothing</span>
            <span class="n">sum</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>synchronizing parallel programs</h1>
<div>
<p>
        The negative effect of synchronizing  parallel programs
        can be illustrated by solving the sum of integers
        problem with all threads sharing one counter.
    </p>
<p>
        The <tt>SumIntervalAcc</tt> class
        is almost identical to the <tt>SumInterval</tt> class,
        but a shared counter is used.
    </p>
<h2 class="src-name"><a href="tests/SumIntervalAcc.java">tests/SumIntervalAcc.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">SumAccumulate</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">sum</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SumAccumulate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span> <span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">long</span> <span class="nf">getSum</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SumThreadAcc</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">startT</span><span class="o">,</span> <span class="n">endT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SumAccumulate</span> <span class="n">acc</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SumThreadAcc</span><span class="o">(</span> <span class="kt">long</span> <span class="n">s</span><span class="o">,</span> <span class="kt">long</span> <span class="n">e</span><span class="o">,</span>  <span class="n">SumAccumulate</span> <span class="n">a</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">startT</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">x</span> <span class="o">);</span>
            <span class="n">x</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getElapsed</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">endT</span><span class="o">-</span><span class="n">startT</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStartT</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">startT</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getEndT</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">endT</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SumIntervalAcc</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">range</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="kt">int</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">);</span>
	<span class="n">SumAccumulate</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SumAccumulate</span><span class="o">();</span>
	<span class="n">acc</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="n">range</span> <span class="o">);</span>

        <span class="kt">long</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">range</span> <span class="o">/</span> <span class="n">threads</span><span class="o">;</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SumThreadAcc</span><span class="o">&gt;</span> <span class="n">sums</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SumThreadAcc</span><span class="o">&gt;();</span>
        <span class="kt">long</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">threads</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">sums</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">SumThreadAcc</span><span class="o">(</span><span class="n">si</span><span class="o">,</span> <span class="n">si</span> <span class="o">+</span> <span class="n">interval</span><span class="o">,</span> <span class="n">acc</span> <span class="o">));</span>
	    <span class="n">si</span> <span class="o">+=</span> <span class="n">interval</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">sums</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="k">new</span> <span class="n">SumThreadAcc</span><span class="o">(</span><span class="n">si</span><span class="o">,</span> <span class="n">range</span><span class="o">,</span> <span class="n">acc</span><span class="o">));</span>

        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">SumThreadAcc</span> <span class="n">t</span> <span class="o">:</span> <span class="n">sums</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span> <span class="n">SumThreadAcc</span> <span class="n">t</span> <span class="o">:</span> <span class="n">sums</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">nanoTime</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"total = "</span> <span class="o">+</span> <span class="n">acc</span><span class="o">.</span><span class="na">getSum</span><span class="o">()</span> <span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"rel start = %11d rel end = %11d (%7.2e)%n"</span><span class="o">,</span>
            <span class="n">begin</span><span class="o">-</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">,</span> <span class="o">(</span><span class="kt">double</span><span class="o">)(</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">)</span> <span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sums</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">SumThreadAcc</span> <span class="n">t</span> <span class="o">=</span> <span class="n">sums</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"t%d %11d %11d %11d (%7.2e)%n"</span><span class="o">,</span>
                <span class="n">i</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getStartT</span><span class="o">()-</span><span class="n">begin</span><span class="o">,</span>
                <span class="n">t</span><span class="o">.</span><span class="na">getEndT</span><span class="o">()-</span><span class="n">begin</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">getElapsed</span><span class="o">(),</span> 
		<span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">t</span><span class="o">.</span><span class="na">getElapsed</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        The results are:
    </p>
<div class="highlight"><pre>% taskset -c 0,1,2,3 java SumIntervalAcc 100000000 4
total = 5000000050000000
rel start =           0 rel end =  8301769146 (8.30e+09)
t0     1039038  8173452112  8172413074 (8.17e+09)
t1     1409566  8301665248  8300255682 (8.30e+09)
t2     1578927  8294885283  8293306356 (8.29e+09)
t3     1619083  8252006395  8250387312 (8.25e+09)
% taskset -c 0,1,2,3 java SumIntervalAcc 100000000 1
total = 5000000050000000
rel start =           0 rel end =  2488566313 (2.49e+09)
t0      663280  2488385435  2487722155 (2.49e+09)
</pre></div>
<p>
       The speedup is 0.300 (2488566313/8301769146).
       Thus with synchronization, the parallel version is
       slower than the single CPU version.
    </p>
<p>
        The non-synchronization version required 45259748nS
        while the synchronization version required 8301769146nS.
        The ratio is 8301769146/45259748 = 183.4.
        Thus the synchronization version is 183.4 times slower.
    </p>
</div>
</div>
<div class="slide">
<h1>Locks</h1>
<div><p>
        Each object in Java has a <b>lock</b>.
        When a synchronized method or code segment is
        entered, an attempt to acquire the lock is made,
        if successful, the code can then be executed.
        If the lock is not available, then the thread
        making the request is blocked, which causes
        the thread to be suspended. When the lock
        is released by the holding thread, then any blocked threads
        are resumed and they can then attempt
        to acquire the lock. A queue is normally used
        to hold the list of blocked threads, and
        the first thread in the queue is unblocked
        when the lock is released.
    </p></div>
</div>
<div class="slide">
<h1>Only one synchronized method per object</h1>
<div>
<p>
        There is only one lock per object. Consider 
        the following class and two threads, A and B.
        <div class="text"><pre><span>class Critical {</span>
<span>    public synchronized void foo() { ... }</span>
<span>    public synchronized void bar() { ... }</span>
<span>    public void foobar() { ... }</span>
<span></span>
<span>}</span>
</pre></div></p>
<ul>
<li>
            If thread A invokes <code>foo</code>, then thread B will
            be blocked when it attempts to invoke <code>foo</code> or
            <code>bar</code>.
        </li>
<li>
            The thread  (thread A) executing in foo can also invoke bar,
            since it already has the lock.
        </li>
<li>
            Any thread can invoke <span class="code">foobar</span> since
            it is not synchronized.
        </li>
</ul>
</div>
</div>
<div class="slide">
<h1>Coordinating threads</h1>
<div>
<p>
        When writing multi-threaded application, it is common
        that coordination of the threads is required
        (i.e., thread A must perform some action before thread B).
        This is accomplished with the following methods
        defined by the Object class:
    </p>
<ul>
<li>
<code>wait()</code> - suspend until notified, added to wait queue </li>
<li>
<code>wait( long timeout )</code> - suspend until notified or timeout expires </li>
<li>
<code>notify()</code> - notify one waiting thread </li>
<li>
<code>notifyAll()</code> - notify all waiting threads</li>
</ul>
<p>
        The methods, <code>wait</code>, <code>notify</code>, and
        <code>notifyAll</code>, can only
        be used inside of a synchronized method or code segment.
        This is not checked at compile time, but is a runtime
        error.
        Requiring the synchronized method or code segment
        eliminates a race between <code>wait</code> and
        <code>notify</code> (e.g., preventing  <code>notify</code>
        occurring before the <code>wait</code>).
    </p>
<p>
        Invoking <code>wait</code> also releases the lock,
        the lock is re-acquired when <code>wait</code> returns.
    </p>
</div>
</div>
<div class="slide">
<h1>simple (but wrong) wait and notify example</h1>
<div>
<p>
        This code demonstrates <code>wait()</code> and
        <code>notify()</code> by having one thread
        wait and the second thread notify the first after 
        a 2000 millisecond delay.
    </p>
<h2 class="src-name"><a href="tests/WaitNotifyEx1.java">tests/WaitNotifyEx1.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyEx1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// static inner class declaration</span>
        <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 waiting"</span><span class="o">);</span>
                    <span class="n">wait</span><span class="o">();</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 interrupted"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="n">r1</span> <span class="o">);</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 sleeping"</span><span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span> <span class="mi">2000</span> <span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 notify r1"</span><span class="o">);</span>
                        <span class="n">r1</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 interrupted"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// use the main thread</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main done"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java WaitNotifyEx1
t2 sleeping
r1 waiting
Exception in thread "Thread-0" java.lang.IllegalMonitorStateException
    at java.lang.Object.wait(Native Method)
    at java.lang.Object.wait(Object.java:503)
    at WaitNotifyEx1$1.run(WaitNotifyEx1.java:10)
    at java.lang.Thread.run(Thread.java:744)
t2 notify r1
Exception in thread "Thread-1" java.lang.IllegalMonitorStateException
    at java.lang.Object.notify(Native Method)
    at WaitNotifyEx1$2.run(WaitNotifyEx1.java:25)
    at java.lang.Thread.run(Thread.java:744)
main done
</pre></div>
<p><tt>Thread-0</tt> throws an exception when <code>wait</code>
        is invoked. The  <code>wait</code> is not synchronized.
        <tt>Thread-1</tt> throws an exception when <code>notify()</code>
        is invoked, again <code>notify()</code> is not synchronized.
    </p>
</div>
</div>
<div class="slide">
<h1>simple wait and notify example</h1>
<div>
<p>
         Synchronizing <code>wait</code> and <code>notify()</code>
         solves the probem.
    </p>
<h2 class="src-name"><a href="tests/WaitNotifyEx2.java">tests/WaitNotifyEx2.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyEx2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// static inner class declaration</span>
        <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 waiting"</span><span class="o">);</span>
                    <span class="kd">synchronized</span><span class="o">(</span> <span class="k">this</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="n">wait</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"r1 interrupted"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="n">r1</span> <span class="o">);</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 sleeping"</span><span class="o">);</span>
                    <span class="c1">// ensure notify happens after wait</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span> <span class="mi">2000</span> <span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 notify r1"</span><span class="o">);</span>
                    <span class="kd">synchronized</span><span class="o">(</span> <span class="n">r1</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="n">r1</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 interrupted"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main done"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java WaitNotifyEx2
t2 sleeping
r1 waiting
t2 notify r1
t2 done
r1 done
</pre></div>
<p>
        When <code>wait</code> is invoked, the mutual exclusive
        lock is released. Up on return the lock is reaquired.
    </p>
</div>
</div>
<div class="slide">
<h1>proper simple wait and notify example</h1>
<div>
<p>
        To ensure that the notification was real, <code>wait</code> 
        is normally placed in the body of a while loop that
        checks for the notify condition.
    </p>
<h2 class="src-name"><a href="tests/WaitNotifyEx3.java">tests/WaitNotifyEx3.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">WaitForNotify</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">notified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">WaitForNotify</span><span class="o">(</span> <span class="n">String</span> <span class="n">id</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">id</span> <span class="o">+</span> <span class="s">" waiting"</span><span class="o">);</span>
            <span class="kd">synchronized</span><span class="o">(</span> <span class="k">this</span> <span class="o">)</span> <span class="o">{</span>
                <span class="cm">/* It is common to test for a condition</span>
<span class="cm">                 * to see if the waiting is no longer required.</span>
<span class="cm">                 * This prevents false  wake ups.</span>
<span class="cm">                 */</span>
                <span class="k">while</span> <span class="o">(</span> <span class="o">!</span><span class="n">notified</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">wait</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">notified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// reset condition</span>
            <span class="o">}</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">id</span> <span class="o">+</span> <span class="s">" done"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">id</span> <span class="o">+</span> <span class="s">" interrupted"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// notifyRequest must be synchronized for the notify()</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">notifyRequest</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">notified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">notify</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyEx3</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">WaitForNotify</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WaitForNotify</span><span class="o">(</span> <span class="s">"w1"</span> <span class="o">);</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="n">w</span> <span class="o">);</span>
        <span class="kd">final</span> <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 sleeping"</span><span class="o">);</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span> <span class="mi">2000</span> <span class="o">);</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 notify r1"</span><span class="o">);</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">notifyRequest</span><span class="o">();</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 interrupted"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// create a new thread</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// use the main thread</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"main done"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre>% java WaitNotifyEx3
t2 sleeping
w1 waiting
t2 notify r1
t2 done
w1 done
main done
</pre></div>
<p>
        Unlike the previous example, thread <tt>t2</tt>
        can call <code>w.notifyRequest()</code>
        before <code>wait()</code> is called.
    </p>
</div>
</div>
<div class="slide">
<h1>wait and notify example</h1>
<div>
<p>
        Using <tt>wait</tt> and <tt>notify</tt> to coordinate
        thread execution is shown in the following example.
        Use of the <code>java.util.Timer</code> and
        <code>java.util.TimerTask</code> is also demonstrated.
        The timer method:
    </p>
<div class="highlight"><pre>schedule(TimerTask task, long delay, long period) 
</pre></div>
<p>
        will run TimerTask every period milliseconds
        after an initial delay of delay milliseconds.
    </p>
<h2 class="src-name"><a href="tests/WaitNotifyTest.java">tests/WaitNotifyTest.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">java.util.Timer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.TimerTask</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stepNo</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxStep</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">// check if the thread can proceed</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">canProceed</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// idiom that ensure no false alarms</span>
        <span class="c1">// waiting should always depend on a condition</span>
        <span class="k">while</span> <span class="o">(</span> <span class="n">stepNo</span> <span class="o">&gt;=</span> <span class="n">maxStep</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span> <span class="c1">// lock is relased by wait</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ignore interruption</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stepNo</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="c1">// allow a blocked thread to proceed</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">allowNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maxStep</span><span class="o">++;</span>
        <span class="n">notify</span><span class="o">();</span> <span class="c1">// notifies only one waiting thread</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Demonstrate thread coordination by allowing</span>
<span class="cm">     * the main thread to proceed when allowed</span>
<span class="cm">     * by the timer task.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">WaitNotifyTest</span> <span class="n">stepper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WaitNotifyTest</span><span class="o">();</span>
        <span class="n">NextStepTask</span> <span class="n">advance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NextStepTask</span><span class="o">(</span> <span class="n">stepper</span> <span class="o">);</span>
        <span class="n">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span> <span class="c1">// mark as Daemon</span>
        <span class="n">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span> <span class="n">advance</span><span class="o">,</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">2000</span> <span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"starting steps"</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">step</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"waiting: "</span> <span class="o">+</span> <span class="n">step</span> <span class="o">);</span>
            <span class="n">stepper</span><span class="o">.</span><span class="na">canProceed</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"step: "</span> <span class="o">+</span> <span class="n">step</span> <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NextStepTask</span> <span class="kd">extends</span> <span class="n">TimerTask</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">WaitNotifyTest</span> <span class="n">stepper</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">NextStepTask</span><span class="o">(</span> <span class="n">WaitNotifyTest</span> <span class="n">stepper</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stepper</span> <span class="o">=</span> <span class="n">stepper</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"allowing next"</span><span class="o">);</span>
            <span class="n">stepper</span><span class="o">.</span><span class="na">allowNext</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        Normally all threads must exit before the Java program
        exits. Any threads marked as <em>daemon</em> will
        not prevent the JVM from exiting when all non-daemon
        threads have terminated.
    </p>
</div>
</div>
<div class="slide">
<h1>wait and notify example output</h1>
<div>
<p>
        The complete output, it must be run dynamically
        to see the delays.
    </p>
<div class="highlight"><pre>% java WaitNotifyTest 
starting steps
waiting: 0
allowing next
step: 0
waiting: 1
allowing next
step: 1
waiting: 2
allowing next
step: 2
waiting: 3
allowing next
step: 3
waiting: 4
allowing next
step: 4
waiting: 5
allowing next
step: 5
waiting: 6
allowing next
step: 6
waiting: 7
allowing next
step: 7
waiting: 8
allowing next
step: 8
waiting: 9
allowing next
step: 9
</pre></div>
</div>
</div>
<div class="slide">
<h1>fairness</h1>
<div>
<p>
        In Java, more than one thread can be blocked on the same X object
        with the wait method. When another thread performs
        a notify operation on the X object, only one
        thread is woken. The notifyAll wakes all threads.
    </p>
<p>
        The JVM picks the next runnable thread based
        on priorities. If there are any threads with the same
        priority then the choice is arbitrary (i.e., there are
        no guarantees).
    </p>
<p>
        Consider the following class which creates two
        CanStep threads that access the same coordination object
        (i.e., they will wait on the same object).
    </p>
<h2 class="src-name"><a href="tests/MultipleThreads.java">tests/MultipleThreads.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.TimerTask</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * Demonstrates the effect of priorities and</span>
<span class="cm"> * difference between notify and notifyALL.</span>
<span class="cm"> * The difference must be studied carefully.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultipleThreads</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stepNo</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxStep</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">all</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MultipleThreads</span><span class="o">(</span> <span class="kt">boolean</span> <span class="n">all</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">all</span> <span class="o">=</span> <span class="n">all</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// check if the thread can proceed</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">canProceed</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// idiom that ensure no false alarms</span>
        <span class="k">while</span> <span class="o">(</span> <span class="n">stepNo</span> <span class="o">&gt;=</span> <span class="n">maxStep</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span> <span class="c1">// lock is relased by wait</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ignore interruption</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stepNo</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="c1">// allow a blocked thread to proceed</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">allowNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maxStep</span><span class="o">++;</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">all</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">notifyAll</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">notify</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">allFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">aPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">bPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span>  <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">allFlag</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">"t"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">aPriority</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">NumberFormatException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ignore</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">bPriority</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">NumberFormatException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ignore</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">MultipleThreads</span> <span class="n">stepper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultipleThreads</span><span class="o">(</span> <span class="n">allFlag</span> <span class="o">);</span>
        <span class="n">NextStep</span> <span class="n">advance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NextStep</span><span class="o">(</span> <span class="n">stepper</span> <span class="o">);</span>
        <span class="n">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span> <span class="c1">// mark as Daemon</span>
        <span class="n">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span> <span class="n">advance</span><span class="o">,</span> <span class="mi">500</span><span class="o">,</span> <span class="mi">1000</span> <span class="o">);</span>

        <span class="n">CanStep</span> <span class="n">c1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CanStep</span><span class="o">(</span><span class="s">"A"</span><span class="o">,</span> <span class="n">stepper</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">aPriority</span> <span class="o">);</span>
        <span class="n">CanStep</span> <span class="n">c2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CanStep</span><span class="o">(</span><span class="s">"B"</span><span class="o">,</span> <span class="n">stepper</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">bPriority</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"started A and B"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// static inner class, prevents pollution</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NextStep</span> <span class="kd">extends</span> <span class="n">TimerTask</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">MultipleThreads</span> <span class="n">stepper</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">NextStep</span><span class="o">(</span> <span class="n">MultipleThreads</span> <span class="n">stepper</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stepper</span> <span class="o">=</span> <span class="n">stepper</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Allow next"</span><span class="o">);</span>
            <span class="n">stepper</span><span class="o">.</span><span class="na">allowNext</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// static inner class, prevents pollution</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CanStep</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">MultipleThreads</span> <span class="n">stepper</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CanStep</span><span class="o">(</span>
            <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
            <span class="n">MultipleThreads</span> <span class="n">stepper</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">priority</span> <span class="o">)</span>
        <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span> <span class="n">name</span> <span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stepper</span> <span class="o">=</span> <span class="n">stepper</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">limit</span> <span class="o">=</span> <span class="n">limit</span><span class="o">;</span>
            <span class="n">setPriority</span><span class="o">(</span> <span class="n">NORM_PRIORITY</span> <span class="o">+</span> <span class="n">priority</span> <span class="o">);</span>
            <span class="n">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span> <span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">;</span> <span class="n">step</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">stepper</span><span class="o">.</span><span class="na">canProceed</span><span class="o">();</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">step</span> <span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="slide">
<h1>starvation of B</h1>
<div>
<p>
        Without due care, we can easily create a situation
        in which one thread will starve (i.e., never get to
        execute). When MultipleThreads is run with:
        <blockquote>
            java MultipleThreads t
        </blockquote>
        The output is:
    </p>
<h2 class="src-name"><a href="tests/mt_t.out">tests/mt_t.out</a></h2>
<div class="highlight"><pre>started A and B
Allow next
A : 0
Allow next
A : 1
Allow next
A : 2
Allow next
B : 0
Allow next
B : 1
Allow next
B : 2
Allow next
B : 3
Allow next
B : 4
</pre></div>
<p>
        Thread B is starved, it only gets to run when
        thread A terminates. If A did not terminate,
        thread B would never get to run.
        The problem is caused by the notifyAll method  which wakes
        up all threads, and the JVM always picks the A thread
        to run.
    </p>
</div>
</div>
<div class="slide">
<h1>equal opportunity</h1>
<div>
<p>
        Threads A and B get to run only when the notify method is used.
        Notify only wakes up one thread, when it blocks again
        it is added to the end of the wait queue.
        This is demonstrated with the command:
        <blockquote>
            java MultipleThreads f
        </blockquote>
        which produces:
    </p>
<h2 class="src-name"><a href="tests/mt_f.out">tests/mt_f.out</a></h2>
<div class="highlight"><pre>started A and B
Allow next
A : 0
Allow next
B : 0
Allow next
A : 1
Allow next
B : 1
Allow next
A : 2
Allow next
B : 2
Allow next
B : 3
Allow next
B : 4
</pre></div>
</div>
</div>
<div class="slide">
<h1>Studying notifyAll</h1>
<div>
<p>
        The <span class="code">Block.doesBlock</span> method
        illustrates what happens when multiple threads
        are blocked by one object (a <span class="code">Block</span>).
        Consider:
    </p>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">Block</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">block</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">unblock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">notifyAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">doesBlock</span><span class="o">(</span> <span class="n">String</span> <span class="n">mesg</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span><span class="o">(</span> <span class="n">block</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"wait:"</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"interrupted: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"notified: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        What happens when <span class="code">doesBlock</span> is invoked?
    </p>
</div>
</div>
<div class="slide">
<h1>Blocking threads</h1>
<div>
<p>
        The <span class="code">BlockingThread.run</span> method invokes
        the <span class="code">Block.doesBlock</span> method.
    </p>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">BlockingThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">Block</span> <span class="n">block</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">mesg</span><span class="o">;</span>

     <span class="kd">public</span> <span class="nf">BlockingThread</span><span class="o">(</span> <span class="n">String</span> <span class="n">mesg</span><span class="o">,</span> <span class="n">Block</span> <span class="n">block</span> <span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">mesg</span> <span class="o">=</span> <span class="n">mesg</span><span class="o">;</span>
         <span class="k">this</span><span class="o">.</span><span class="na">block</span> <span class="o">=</span> <span class="n">block</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">block</span><span class="o">.</span><span class="na">doesBlock</span><span class="o">(</span> <span class="n">mesg</span> <span class="o">);</span>
     <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
        The thread finishes after returning from
        <span class="code">Block.doesBlock</span>.
    </p>
</div>
</div>
<div class="slide">
<h1>Creating Blocking threads</h1>
<div>
<p>
        A single <span class="code">Block</span> object and a set of 
        <span class="code">BlockingThread</span> threads are created with:
    </p>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
<span class="n">Block</span> <span class="n">block</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Block</span><span class="o">();</span>
<span class="n">BlockingThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockingThread</span><span class="o">[</span><span class="n">numThreads</span><span class="o">];</span>

<span class="k">for</span> <span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">m</span> <span class="o">=</span> <span class="s">"th"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
    <span class="n">BlockingThread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockingThread</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">block</span><span class="o">);</span>
    <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">threads</span><span class="o">[</span> <span class="n">i</span> <span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">Scanner</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span> <span class="n">System</span><span class="o">.</span><span class="na">in</span> <span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"cmd: "</span><span class="o">);</span>
</pre></div>
<p>
        All the threads will block after each thread invokes
        <span class="code">Block.doesBlock</span>.
        The initial output when <span class="code">args[0] == "6"</span> is:
    </p>
<h2 class="src-name"><a href="tests/NotifyAll6.out">tests/NotifyAll6.out</a></h2>
<div class="highlight"><pre>wait:th0 true
wait:th1 true
wait:th2 true
wait:th3 true
wait:th4 true
cmd: wait:th5 true
</pre></div>
<p>
        Why is the last line: <tt>cmd: wait:th5 true</tt> produced?
    </p>
</div>
</div>
<div class="slide">
<h1>Testing NotifyAll</h1>
<div>
<p>
        Again, the <span class="code">Block.doesBlock</span> is defined as:
    </p>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">doesBlock</span><span class="o">(</span> <span class="n">String</span> <span class="n">mesg</span> <span class="o">)</span> <span class="o">{</span>
    <span class="k">while</span><span class="o">(</span> <span class="n">block</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"wait:"</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">wait</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"interrupted: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"notified: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
    <span class="o">}</span>
    <span class="n">block</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>
        Testing is done by:
    </p>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre>        <span class="n">Scanner</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span> <span class="n">System</span><span class="o">.</span><span class="na">in</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"cmd: "</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span> <span class="n">sc</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"exit"</span> <span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">block</span><span class="o">.</span><span class="na">unblock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"cmd: "</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<ul><li>What happens when a blank line is entered?</li></ul>
</div>
</div>
<div class="slide">
<h1>Source for NotifyAll</h1>
<div>
<h2 class="src-name"><a href="tests/NotifyAll.java">tests/NotifyAll.java</a></h2>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Block</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">block</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">unblock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">notifyAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">doesBlock</span><span class="o">(</span> <span class="n">String</span> <span class="n">mesg</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span><span class="o">(</span> <span class="n">block</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"wait:"</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">catch</span><span class="o">(</span> <span class="n">InterruptedException</span> <span class="n">ex</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"interrupted: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="s">"notified: "</span> <span class="o">+</span> <span class="n">mesg</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">block</span> <span class="o">);</span>
        <span class="o">}</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">BlockingThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">Block</span> <span class="n">block</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">mesg</span><span class="o">;</span>

     <span class="kd">public</span> <span class="nf">BlockingThread</span><span class="o">(</span> <span class="n">String</span> <span class="n">mesg</span><span class="o">,</span> <span class="n">Block</span> <span class="n">block</span> <span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">mesg</span> <span class="o">=</span> <span class="n">mesg</span><span class="o">;</span>
         <span class="k">this</span><span class="o">.</span><span class="na">block</span> <span class="o">=</span> <span class="n">block</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">block</span><span class="o">.</span><span class="na">doesBlock</span><span class="o">(</span> <span class="n">mesg</span> <span class="o">);</span>
     <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotifyAll</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">numThreads</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">);</span>
        <span class="n">Block</span> <span class="n">block</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Block</span><span class="o">();</span>
        <span class="n">BlockingThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockingThread</span><span class="o">[</span><span class="n">numThreads</span><span class="o">];</span>

        <span class="k">for</span> <span class="o">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">m</span> <span class="o">=</span> <span class="s">"th"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">BlockingThread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockingThread</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">block</span><span class="o">);</span>
            <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">threads</span><span class="o">[</span> <span class="n">i</span> <span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Scanner</span> <span class="n">sc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span> <span class="n">System</span><span class="o">.</span><span class="na">in</span> <span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"cmd: "</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span> <span class="n">sc</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">line</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"exit"</span> <span class="o">)</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span> <span class="mi">1</span> <span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">block</span><span class="o">.</span><span class="na">unblock</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"cmd: "</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div></body>
</html>
